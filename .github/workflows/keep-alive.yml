name: Keep Render Backend Alive
on:
  schedule:
    - cron: "*/13 * * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Render Backend Health Endpoint
        env:
          API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          echo "🔄 Sending keep-alive ping to backend..."
          echo "🕐 Timestamp: $(date -u)"
          echo "🎯 Target: ${API_URL}/health"
          echo "⏰ Interval: Every 13 minutes (stays within GitHub free tier)"
          echo ""

          # Ping the health endpoint with timeout
          response=$(curl -s -w "%{http_code}" -m 30 -o /tmp/response.json ${API_URL}/health)

          # Check if request was successful
          if [ "$response" = "200" ]; then
            echo "✅ Keep-alive successful! Backend is healthy."
            echo "📊 Backend Response:"
            cat /tmp/response.json | jq '.' 2>/dev/null || cat /tmp/response.json
            echo ""
            echo "🎉 Render backend will stay active for another ~15 minutes"
          else
            echo "❌ Keep-alive failed with HTTP status: $response"
            echo "📊 Response body:"
            cat /tmp/response.json
            echo ""
            echo "⚠️ Backend might be spinning down or experiencing issues"
            
            # Don't fail the workflow for non-200 responses during spin-up
            if [ "$response" = "503" ] || [ "$response" = "502" ]; then
              echo "ℹ️ Backend might be starting up (HTTP $response). This is normal during spin-up."
              exit 0
            fi
            
            exit 1
          fi

      - name: Summary
        if: always()
        env:
          API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "🤖 Keep-Alive Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📅 Date: $(date -u)"
          echo "⏰ Next check: In 13 minutes"
          echo "📈 Purpose: Prevent Render free tier spin-down"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
